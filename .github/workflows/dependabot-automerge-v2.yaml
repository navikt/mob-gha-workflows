name: Dependabot auto-merge (GitHub App)

on:
  workflow_call:
    inputs:
      minimum-age-of-pr:
        description: "Minimum age of PR in days before automerging"
        required: false
        type: string
        default: "2"
      ignored-dependencies:
        description: "Comma-separated list of dependencies to ignore"
        required: false
        type: string
        default: ""
      semver-filter:
        description: "Semver filter for automerge (e.g., patch, minor, major)"
        required: false
        type: string
        default: "patch,minor"
      always-allow:
        description: "Comma-separated list of dependencies to always allow"
        required: false
        type: string
        default: ""
      auto-approve:
        description: "Whether to automatically approve PRs before merging them"
        required: false
        type: boolean
        default: true
      merge-method:
        description: "The merge method to use when merging pull requests (merge, squash, rebase)"
        required: false
        type: string
        default: "merge"
    secrets:
      APP_ID:
        description: "GitHub App ID"
        required: true
      PRIVATE_KEY:
        description: "GitHub App Private Key"
        required: true
  workflow_dispatch:

jobs:
  dependabot-automerge:
    runs-on: ubuntu-latest
    outputs:
      merged-pr-count: ${{ steps.automerge.outputs.merged-pr-count }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # ratchet:step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Create GitHub App Token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # ratchet:actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: Automerge Dependabot PRs
        id: automerge
        uses: navikt/automerge-dependabot@ac191a29cb73550ba1506bfea3ee0c38fbbdeeb2 # ratchet:navikt/automerge-dependabot@main
        with:
          token: ${{ steps.app-token.outputs.token }}
          minimum-age-of-pr: ${{ inputs.minimum-age-of-pr }}
          blackout-periods: "Sat,Sun,May 1,May 17,Dec 24-Jan 3"
          ignored-dependencies: ${{ inputs.ignored-dependencies }}
          semver-filter: ${{ inputs.semver-filter }}
          always-allow: ${{ inputs.always-allow }}
          auto-approve: ${{ inputs.auto-approve }}
          merge-method: ${{ inputs.merge-method }}

      - name: Automerge results
        run: |
          echo "Automerge Results:"
          echo "Number of merged PRs: $MERGED_PR_COUNT"
          if [ "$MERGED_PR_COUNT" != "0" ]; then
            echo "$MERGED_PR_COUNT PR(s) merged. Deployment workflows will be triggered automatically by the merge event."
          else
            echo "No PRs were merged."
          fi
        env:
          MERGED_PR_COUNT: ${{ steps.automerge.outputs.merged-pr-count }}
